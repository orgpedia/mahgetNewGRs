# mahgetNewGR

Unified Maharashtra GR pipeline using yearly JSONL ledgers in `import/grinfo/`.

## CLI

All commands run through:

```bash
python3 import/src/cli.py <command> [options]
```

Main commands:

- `baseline-ledger` – build initial ledger from `mahgetGR` and `mahgetAllGR`
- `append-ledger` – append-only incremental ingest from `mahgetGR` into existing ledger
- `backfill-lfs-path` – one-time refresh of ledger `lfs_path` based on local PDF files
- `validate-ledger` – validate schema/state/partition consistency
- `update-readme-status` – refresh README status table from current ledger
- `import-pdfs` – one-time import of local PDF folders into `LFS/pdfs` + optional HF sync
- `job-gr-site` – crawl reconciliation + download stage (`daily|weekly|monthly`)
- `job-wayback` – Wayback SPN2 stage
- `job-archive` – Archive stage (+ metadata fallback/recovery)
- `daily`, `weekly`, `monthly` – top-level workflow orchestrators
- `sync-hf` – sync local artifacts with HF dataset using `huggingface_hub` APIs (upload/download)

## Make targets

Use `make help` for available targets. Required spec targets:

- `make daily`
- `make weekly`
- `make monthly`
- `make job-gr-site`
- `make job-wayback`
- `make job-archive`
- `make validate`
- `make status-readme`
- `make import-pdfs`
- `make append-ledger`
- `make backfill-lfs-path`
- `make sync-hf`

## Credentials

Environment variables used by stages:

- Wayback SPN2 + Archive.org: `IA_ACCESS_KEY`, `IA_SECRET_KEY`
- HF sync: `HF_TOKEN`, `HF_DATASET_REPO_PATH`, `HF_DATASET_REPO_URL` (or `HF_DATASET_REPO_ID`)

## Hugging Face sync modes

`sync-hf` is API-based (no local git clone required) and supports:

- upload everything under local sync path:
  - `python3 import/src/cli.py sync-hf --mode upload --hf-repo-path LFS/mahGRs`
- upload only one prefix:
  - `python3 import/src/cli.py sync-hf --mode upload --hf-repo-path LFS/mahGRs --prefix pdfs/mahagri/2026-01`
- download one prefix:
  - `python3 import/src/cli.py sync-hf --mode download --hf-repo-path LFS/mahGRs --prefix pdfs/mahagri/2026-01`
- download one file:
  - `python3 import/src/cli.py sync-hf --mode download --hf-repo-path LFS/mahGRs --file pdfs/mahagri/2026-01/202601011234567890.pdf`

By default, both upload and download exclude `import/grinfo`; pass `--include-ledger` only if you intentionally want ledger files in HF sync.

Large upload behavior:
- `sync-hf` auto-uses `upload_large_folder` for big directory uploads (default threshold: 100 files).
- Override with:
  - `--large-folder-mode auto|always|never`
  - `--large-folder-threshold <count>`
  - `--large-folder-num-workers <n>`

## Setup templates

- Local env template: `.env`
- GitHub Web UI secrets/variables checklist: `GITHUB_ACTIONS_WEB_UI_TEMPLATE.md`

All local CLI entrypoints auto-load `.env` (searching current directory upward) before argument parsing.

## One-time PDF import

Use this when you already have downloaded PDFs in a local directory:

```bash
python3 import/src/cli.py import-pdfs \
  --source-dir /path/to/existing/pdfs \
  --hf-repo-path LFS/mahGRs
```

Notes:
- File names should contain a `unique_code` (16-22 digit token).
- Destination path is `LFS/pdfs/<department_code>/<YYYY-MM>/<unique_code>.pdf`.
- `department_code` and `gr_date` month are derived from ledger records.
- Files without a matching ledger record are skipped.
- `department_code` uses the shared abbreviation map in `import/src/department_codes.py` (for example, School Education → `mahedu`).

## `lfs_path` field

- Ledger records now include top-level `lfs_path`.
- It stores the local PDF location (for example `LFS/mahGRs/pdfs/mahagri/2025-10/202510131610444101.pdf`) when present.
- If no local PDF exists for that record, `lfs_path` is `null`.
- Use `python3 import/src/cli.py backfill-lfs-path --ledger-dir import/grinfo` for one-time backfill on existing ledgers.

## Repository Status

This section is auto-generated by `update-readme-status` and refreshed by run-oriented `make` targets.

<!-- STATUS_TABLE_START -->
_Last updated (UTC): 2026-02-09T05:43:24Z_

| Metric | Count |
| --- | ---: |
| Total records | 172210 |
| Ledger partitions | 101 |
| Downloaded PDF files (`LFS/pdfs`) | 0 |

### State Distribution

| State | Count |
| --- | ---: |
| `FETCHED` | 39 |
| `DOWNLOAD_SUCCESS` | 0 |
| `DOWNLOAD_FAILED` | 0 |
| `WAYBACK_UPLOADED` | 177 |
| `WAYBACK_UPLOAD_FAILED` | 11060 |
| `ARCHIVE_UPLOADED_WITH_WAYBACK_URL` | 33551 |
| `ARCHIVE_UPLOADED_WITHOUT_WAYBACK_URL` | 127383 |
| `ARCHIVE_UPLOADED_WITHOUT_DOCUMENT` | 0 |

### Stage Progress

| Stage | Success | Failed | Pending | Retryable |
| --- | ---: | ---: | ---: | ---: |
| Download | 160728 | 385 | 11097 | 385 |
| Wayback | 33728 | 138443 | 0 | 138438 |
| Archive | 160934 | 11237 | 0 | 10991 |
<!-- STATUS_TABLE_END -->
